<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Schedule Generator</title>
  <style>
    /* Basic reset */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* Colors and variables */
    :root {
      --primary: #4361ee;
      --secondary: #6c757d;
      --success: #28a745;
      --danger: #dc3545;
      --light: #f8f9fa;
      --dark: #343a40;
      --background: #f5f7fa;
    }

    /* Base styles */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      color: var(--dark);
      background: var(--background);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    /* Container */
    .app-container {
      width: 100%;
      max-width: 600px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    /* Header */
    .app-header {
      background: var(--primary);
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }

    .app-header h1 {
      font-size: 1.6rem;
      margin: 0;
    }

    .back-link {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: white;
      text-decoration: none;
    }

    /* Media query for small screens */
    @media (max-width: 480px) {
      .app-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px;
      }

      .back-link {
        position: static;
        transform: none;
        margin-bottom: 10px;
      }
    }

    /* Form container */
    .form-container {
      padding: 30px;
    }

    /* Steps indicator */
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
    }

    .step {
      display: flex;
      align-items: center;
      flex-direction: column;
      flex: 1;
    }

    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #dee2e6;
      color: #6c757d;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .step.active .step-number {
      background-color: var(--primary);
      color: white;
    }

    .step.completed .step-number {
      background-color: var(--success);
      color: white;
    }

    .step-label {
      font-size: 0.8rem;
      color: #6c757d;
      text-align: center;
    }

    .step.active .step-label {
      color: var(--primary);
      font-weight: bold;
    }

    /* Form elements */
    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 1rem;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }

    .help-text {
      font-size: 0.8rem;
      color: #6c757d;
      margin-top: 6px;
    }

    /* Buttons */
    .btn {
      display: inline-block;
      font-weight: 500;
      text-align: center;
      padding: 10px 20px;
      font-size: 1rem;
      line-height: 1.5;
      border-radius: 4px;
      cursor: pointer;
      border: none;
    }

    .btn-primary {
      color: white;
      background-color: var(--primary);
    }

    .btn-primary:hover {
      background-color: #3249c9;
    }

    .btn-secondary {
      color: white;
      background-color: var(--secondary);
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .btn-success {
      color: white;
      background-color: var(--success);
    }

    .btn-success:hover {
      background-color: #218838;
    }

    .btn-block {
      display: block;
      width: 100%;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 30px;
    }

    /* Vacation list */
    .vacation-card {
      background-color: #f8f9fa;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .vacation-info {
      flex: 1;
    }

    .employee-badge {
      background-color: var(--primary);
      color: white;
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 0.85rem;
      display: inline-block;
      margin-bottom: 5px;
    }

    .delete-btn {
      color: var(--danger);
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
    }

    .vacation-list {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 20px;
    }

    /* Alerts */
    .alert {
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }

    .alert-danger {
      color: #721c24;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
    }

    .alert-success {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
    }

    /* Checkbox styles */
    .checkbox-container {
      display: flex;
      align-items: center;
      margin-top: 15px;
      margin-bottom: 15px;
    }

    .checkbox-container input[type="checkbox"] {
      margin-right: 8px;
    }

    .checkbox-container label {
      display: inline;
      margin-bottom: 0;
    }

    /* Slider styles */
    .slider-container {
      margin-top: 15px;
      margin-bottom: 20px;
    }

    .slider-container label {
      display: block;
      margin-bottom: 8px;
    }

    .slider-wrapper {
      display: flex;
      align-items: center;
    }

    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: #d3d3d3;
      outline: none;
      margin-right: 10px;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }

    .slider-value {
      min-width: 30px;
      text-align: center;
      font-weight: bold;
    }

    /* Action buttons container */
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <a href="/" class="back-link">Back</a>
      <h1>Schedule Generator</h1>
    </header>

    <div class="form-container">
      <div class="step-indicator">
        <div class="step active" id="step1-indicator">
          <div class="step-number">1</div>
          <div class="step-label">Staff</div>
        </div>
        <div class="step" id="step2-indicator">
          <div class="step-number">2</div>
          <div class="step-label">Holidays</div>
        </div>
        <div class="step" id="step3-indicator">
          <div class="step-number">3</div>
          <div class="step-label">Vacations</div>
        </div>
      </div>

      <div id="errorAlert" class="alert alert-danger"></div>
      <div id="successAlert" class="alert alert-success"></div>

      <form id="stepForm">
        <!-- Step 1: Number of Employees -->
        <div class="step-content active" id="step1">
          <div class="form-group">
            <label for="numEmployeesStep">Number of Employees</label>
            <input type="number" class="form-control" id="numEmployeesStep" min="1" value="35" required>
            <p class="help-text">Enter the total number of employees to be scheduled</p>
          </div>

          <div class="checkbox-container">
            <input type="checkbox" id="includeNightShift">
            <label for="includeNightShift">Include night shift</label>
          </div>

          <div class="slider-container">
            <label for="nightShiftSlider">Night shift staff per shift</label>
            <div class="slider-wrapper">
              <input type="range" min="2" max="10" value="4" class="slider" id="nightShiftSlider">
              <span class="slider-value" id="nightShiftValue">4</span>
            </div>
          </div>

          <div class="checkbox-container">
            <input type="checkbox" id="includePmShift">
            <label for="includePmShift">Include PM shift</label>
          </div>

          <div class="slider-container">
            <label for="pmShiftSlider">PM shift staff per shift</label>
            <div class="slider-wrapper">
              <input type="range" min="2" max="10" value="4" class="slider" id="pmShiftSlider">
              <span class="slider-value" id="pmShiftValue">4</span>
            </div>
          </div>

          <div class="checkbox-container">
            <input type="checkbox" id="includeWeekendShift">
            <label for="includeWeekendShift">Include weekend shift</label>
          </div>

          <div class="slider-container">
            <label for="weekendShiftSlider">Weekend shift staff per shift</label>
            <div class="slider-wrapper">
              <input type="range" min="2" max="10" value="4" class="slider" id="weekendShiftSlider">
              <span class="slider-value" id="weekendShiftValue">4</span>
            </div>
          </div>

          <button type="button" class="btn btn-primary" onclick="nextStep(1, this)">Continue</button>
        </div>

        <!-- Step 2: Holidays -->
        <div class="step-content" id="step2">
          <div class="form-group">
            <label for="monthStep">Select Month</label>
            <select class="form-control" id="monthStep" required>
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
            <p class="help-text">Select the month for scheduling</p>
          </div>

          <div class="form-group">
            <label for="holidaysStep">Holidays (comma-separated days, optional)</label>
            <input type="text" class="form-control" id="holidaysStep" placeholder="E.g., 2,3,15">
            <p class="help-text">Enter comma-separated day numbers for holidays. Leave empty if none.</p>
          </div>

          <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="prevStep(2)">Back</button>
            <button type="button" class="btn btn-primary" onclick="nextStep(2, this)">Continue</button>
          </div>
        </div>

        <!-- Step 3: Vacations -->
        <div class="step-content" id="step3">
          <div class="form-group">
            <label for="employeeSelectStep">Select Employee</label>
            <select class="form-control" id="employeeSelectStep">
              <option value="">-- Select Employee --</option>
            </select>
          </div>

          <div class="form-group">
            <label for="vacationStartStep">Vacation Start Day</label>
            <input type="number" class="form-control" id="vacationStartStep" min="1" max="31">
          </div>

          <div class="form-group">
            <label for="vacationEndStep">Vacation End Day</label>
            <input type="number" class="form-control" id="vacationEndStep" min="1" max="31">
          </div>

          <button type="button" class="btn btn-primary" id="addVacationStep">Add Vacation</button>

          <div class="vacation-list">
            <h3>Vacation Details</h3>
            <ul id="vacationList"></ul>
          </div>

          <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="prevStep(3)">Back</button>
            <div class="action-buttons">
              <button type="button" class="btn btn-success" id="saveButton">Save Schedule</button>
              <button type="submit" class="btn btn-primary">Download Schedule</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Get current month (1-12)
const currentDate = new Date();
const currentMonthIndex = currentDate.getMonth() + 2; // getMonth() returns 0-11

// Global variables to track form state
let numEmployees = 0;
let selectedMonth = currentMonthIndex;
let vacations = {};
let includeNightShift = false;
let includePmShift = false;
let includeWeekendShift = false;
let nightShiftStaff = 4;
let pmShiftStaff = 4;
let weekendShiftStaff = 4;

// Get DOM elements
const stepForm = document.getElementById('stepForm');
const numEmployeesInput = document.getElementById('numEmployeesStep');
const monthSelect = document.getElementById('monthStep');
const holidaysInput = document.getElementById('holidaysStep');
const nightShiftCheckbox = document.getElementById('includeNightShift');
const pmShiftCheckbox = document.getElementById('includePmShift');
const weekendShiftCheckbox = document.getElementById('includeWeekendShift');
const nightShiftSlider = document.getElementById('nightShiftSlider');
const pmShiftSlider = document.getElementById('pmShiftSlider');
const weekendShiftSlider = document.getElementById('weekendShiftSlider');
const nightShiftValue = document.getElementById('nightShiftValue');
const pmShiftValue = document.getElementById('pmShiftValue');
const weekendShiftValue = document.getElementById('weekendShiftValue');
const saveButton = document.getElementById('saveButton');

// Set the month select to the current month
monthSelect.value = currentMonthIndex;

// Update slider value displays when sliders change
nightShiftSlider.addEventListener('input', function() {
  nightShiftValue.textContent = this.value;
  nightShiftStaff = parseInt(this.value);
});

pmShiftSlider.addEventListener('input', function() {
  pmShiftValue.textContent = this.value;
  pmShiftStaff = parseInt(this.value);
});

weekendShiftSlider.addEventListener('input', function() {
  weekendShiftValue.textContent = this.value;
  weekendShiftStaff = parseInt(this.value);
});

const employeeSelect = document.getElementById('employeeSelectStep');
const vacationStartInput = document.getElementById('vacationStartStep');
const vacationEndInput = document.getElementById('vacationEndStep');
const addVacationButton = document.getElementById('addVacationStep');
const vacationList = document.getElementById('vacationList');
const errorAlert = document.getElementById('errorAlert');
const successAlert = document.getElementById('successAlert');

// Get step indicators
const step1Indicator = document.getElementById('step1-indicator');
const step2Indicator = document.getElementById('step2-indicator');
const step3Indicator = document.getElementById('step3-indicator');

// Fixed Save button click handler
saveButton.addEventListener('click', function() {
  try {
    const userId = getUserIdFromToken();
    const userEmail = getUserEmailFromToken();

    // Validate required fields
    if (!userId) {
      showError('User ID not found. Please log in again.');
      return;
    }

    if (!userEmail) {
      showError('User email not found. Please log in again.');
      return;
    }

    const holidaysString = holidaysInput.value.trim();
    const holidays = holidaysString ? holidaysString.split(',').map(h => h.trim()).filter(h => h) : [];

    const stringVacations = {};
    for (const employeeId in vacations) {
      stringVacations[employeeId] = vacations[employeeId].map(day => String(day));
    }

    // Create include_shift array: [night_shift, pm_shift, weekend_shift]
    const includeShiftArray = [
      includeNightShift ? 1 : 0,
      includePmShift ? 1 : 0,
      includeWeekendShift ? 1 : 0
    ];

    // Create emp_per_shift array: [night_shift_staff, pm_shift_staff, weekend_shift_staff]
    const empPerShiftArray = [
      nightShiftStaff,
      pmShiftStaff,
      weekendShiftStaff
    ];

    const scheduleData = {
      e_num: parseInt(numEmployeesInput.value),
      include_shift: includeShiftArray,
      emp_per_shift: empPerShiftArray,
      holi: holidays,
      monthh: parseInt(monthSelect.value),
      vac: stringVacations,
      down: 'up'
    };

    console.log("Calling /d with scheduleData:", scheduleData);

    // First generate the schedule
    fetch('/d', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(scheduleData)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`Schedule generation failed: ${response.status} ${response.statusText}`);
      }
      return response.blob();
    })
    .then(blob => {
      console.log("Schedule generated successfully, now saving...");

      // Now save the file with proper structure
      const saveData = {
        user_id: userId,
        user_email: userEmail,
        original_filename: 'schedule.xlsx'
      };

      console.log("Calling /savefile with saveData:", saveData);

      return fetch('/savefile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(saveData)
      });
    })
    .then(response => {
      if (!response.ok) {
        return response.text().then(text => {
          throw new Error(`Save failed: ${response.status} ${response.statusText} - ${text}`);
        });
      }
      return response.json();
    })
    .then(data => {
      showSuccess('Schedule generated and saved successfully!');
      console.log("Save success:", data);
    })
    .catch(error => {
      showError('Error: ' + error.message);
      console.error("Save error:", error);
    });

  } catch (error) {
    showError('Unexpected error: ' + error.message);
    console.error("Save function error:", error);
  }
});

function getUserIdFromToken() {
  try {
    const token = localStorage.getItem("token");
    if (!token) {
      console.error("No token found in localStorage");
      return null;
    }

    const payload = JSON.parse(atob(token.split('.')[1]));
    // Try different possible field names for user ID
    const userId = payload.user_id || payload.sub || payload.id;

    if (!userId) {
      console.error("No user ID found in token payload:", payload);
      return null;
    }

    // Convert to string if it's a number (since your DB expects integer but we send as string)
    return String(userId);

  } catch (err) {
    console.error("Error parsing token:", err);
    return null;
  }
}

function getUserEmailFromToken() {
  try {
    const token = localStorage.getItem("token");
    if (!token) {
      console.error("No token found in localStorage");
      return null;
    }

    const payload = JSON.parse(atob(token.split('.')[1]));
    // Try different possible field names for email
    const email = payload.email || payload.user_email || payload.mail;

    if (!email) {
      console.error("No email found in token payload:", payload);
      return null;
    }

    return email;

  } catch (err) {
    console.error("Error parsing token:", err);
    return null;
  }
}

// Function to move to next step
function nextStep(currentStep, button) {
  console.log("nextStep called with currentStep:", currentStep);
  hideAlerts();

  try {
    if (currentStep === 1) {
      numEmployees = parseInt(numEmployeesInput.value);
      includeNightShift = nightShiftCheckbox.checked;
      includePmShift = pmShiftCheckbox.checked;
      includeWeekendShift = weekendShiftCheckbox.checked;
      nightShiftStaff = parseInt(nightShiftSlider.value);
      pmShiftStaff = parseInt(pmShiftSlider.value);
      weekendShiftStaff = parseInt(weekendShiftSlider.value);

      console.log("Step 1 values:", {
        numEmployees,
        includeNightShift,
        includePmShift,
        includeWeekendShift,
        nightShiftStaff,
        pmShiftStaff,
        weekendShiftStaff
      });

      if (isNaN(numEmployees) || numEmployees < 1) {
        showError('Please enter a valid number of employees');
        return;
      }

      populateEmployeeSelect();

      step1Indicator.className = 'step completed';
      step2Indicator.className = 'step active';

    } else if (currentStep === 2) {
      selectedMonth = parseInt(monthSelect.value);
      if (isNaN(selectedMonth) || selectedMonth < 1 || selectedMonth > 12) {
        showError('Please select a valid month');
        return;
      }

      step2Indicator.className = 'step completed';
      step3Indicator.className = 'step active';
    }

    document.getElementById(`step${currentStep}`).classList.remove('active');
    document.getElementById(`step${currentStep + 1}`).classList.add('active');

  } catch (error) {
    console.error("Error in nextStep:", error);
    showError("An error occurred while moving to the next step");
  }
}

// Go back to previous step
function prevStep(currentStep) {
  hideAlerts();

  if (currentStep === 2) {
    step1Indicator.className = 'step active';
    step2Indicator.className = 'step';
  } else if (currentStep === 3) {
    step2Indicator.className = 'step active';
    step3Indicator.className = 'step';
  }

  document.getElementById(`step${currentStep}`).classList.remove('active');
  document.getElementById(`step${currentStep - 1}`).classList.add('active');
}

// Populate employee select dropdown
function populateEmployeeSelect() {
  employeeSelect.innerHTML = '<option value="">-- Select Employee --</option>';
  for (let i = 1; i <= numEmployees; i++) {
    const option = document.createElement('option');
    option.value = i;
    option.textContent = `Employee ${i}`;
    employeeSelect.appendChild(option);
  }
}

// Add vacation for employee
addVacationButton.addEventListener('click', function() {
  const employeeId = employeeSelect.value;
  const startDay = parseInt(vacationStartInput.value);
  const endDay = parseInt(vacationEndInput.value);

  if (!employeeId) {
    showError('Please select an employee');
    return;
  }

  if (isNaN(startDay) || startDay < 1) {
    showError('Please enter a valid start day');
    return;
  }

  if (isNaN(endDay) || endDay < 1 || endDay < startDay) {
    showError('Please enter a valid end day (must be >= start day)');
    return;
  }

  vacations[employeeId] = [startDay, endDay];
  updateVacationList();

  employeeSelect.value = '';
  vacationStartInput.value = '';
  vacationEndInput.value = '';

  showSuccess('Vacation added successfully');
});

// Update vacation list
function updateVacationList() {
  vacationList.innerHTML = '';

  for (const employeeId in vacations) {
    const dates = vacations[employeeId];

    const li = document.createElement('li');
    li.className = 'vacation-card';

    const info = document.createElement('div');
    info.className = 'vacation-info';

    const employeeBadge = document.createElement('div');
    employeeBadge.className = 'employee-badge';
    employeeBadge.textContent = `Employee ${employeeId}`;

    const dateInfo = document.createElement('div');
    dateInfo.textContent = `Days ${dates[0]} - ${dates[1]}`;

    const deleteButton = document.createElement('button');
    deleteButton.className = 'delete-btn';
    deleteButton.textContent = 'X';
    deleteButton.onclick = function() {
      delete vacations[employeeId];
      updateVacationList();
    };

    info.appendChild(employeeBadge);
    info.appendChild(dateInfo);

    li.appendChild(info);
    li.appendChild(deleteButton);

    vacationList.appendChild(li);
  }
}

// Form submission
stepForm.addEventListener('submit', function(e) {
  e.preventDefault();

  try {
    const holidaysString = holidaysInput.value.trim();
    const holidays = holidaysString ? holidaysString.split(',').map(h => h.trim()).filter(h => h) : [];

    const stringVacations = {};
    for (const employeeId in vacations) {
      stringVacations[employeeId] = vacations[employeeId].map(day => String(day));
    }

    // Create include_shift array: [night_shift, pm_shift, weekend_shift]
    const includeShiftArray = [
      includeNightShift ? 1 : 0,
      includePmShift ? 1 : 0,
      includeWeekendShift ? 1 : 0
    ];

    // Create emp_per_shift array: [night_shift_staff, pm_shift_staff, weekend_shift_staff]
    const empPerShiftArray = [
      nightShiftStaff,
      pmShiftStaff,
      weekendShiftStaff
    ];

    const data = {
      e_num: parseInt(numEmployees),
      include_shift: includeShiftArray,
      emp_per_shift: empPerShiftArray,
      holi: holidays,
      monthh: parseInt(selectedMonth),
      vac: stringVacations
    };

    fetch('/d', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (response.ok) {
        return response.blob();
      } else {
        throw new Error('Failed to generate schedule');
      }
    })
    .then(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Schedule.xlsx';
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);

      showSuccess('Schedule generated successfully!');
    })
    .catch(error => {
      showError(error.message);
    });
  } catch (error) {
    showError('An error occurred. Please try again.');
  }
});

// Alert helpers
function showError(message) {
  errorAlert.textContent = message;
  errorAlert.style.display = 'block';
  successAlert.style.display = 'none';
}

function showSuccess(message) {
  successAlert.textContent = message;
  successAlert.style.display = 'block';
  errorAlert.style.display = 'none';
}

function hideAlerts() {
  errorAlert.style.display = 'none';
  successAlert.style.display = 'none';
}
  </script>
</body>
</html>
